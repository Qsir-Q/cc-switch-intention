# 4.6 意图路由（Claude CLI）

## 功能说明

意图路由用于 **Claude CLI** 接入场景：  
当多个 Claude 供应商 / 模型同时启用时，根据“这次对话要做什么”，自动选择更合适的供应商或模型，而不是只用主界面当前选中的那个。

典型用途：
- 同时配置「通用对话」和「代码/数学增强」的不同供应商
- 使用一个「路由专用供应商」来负责判断，再把请求转发到其它供应商
- 减少手动来回切换供应商的操作

> 注意：当前版本仅对 **Claude CLI 的 `/v1/messages`** 请求生效，不会影响 Codex、Gemini 等应用。

---

## 开启意图路由

### 1. 启用代理和应用接管

意图路由依赖本地代理，因此需要：

1. 在主界面顶部开启 **代理开关**（Proxy）
2. 开启 **Claude 接管**，让 Claude CLI 请求通过本地代理：
   - 可以在主界面顶部的 Claude 区域开启接管  
   - 或在「设置 → 高级 → 代理服务 → 应用接管」里开启 **Claude 接管**

### 2. 在设置中启用 Claude CLI 意图路由

1. 打开「设置 → 高级 → 代理服务」
2. 在「本地代理」区域中找到：
   - 「启用 Claude CLI 意图路由」开关
3. 打开该开关
4. 可选：在「路由专用供应商」下拉框中选择一个供应商，作为“路由模型”使用

> 不选择路由专用供应商时，会使用当前 Claude 供应商的主模型做路由判断。

### 3. 主界面快捷开关

当代理和 Claude 接管已开启时，主界面顶部会显示一个 **意图路由开关**：

- 在 Claude 应用右侧，和「故障转移」开关同一行
- 图标为 ✨（Sparkles），旁边是一个开关（Switch）
- 开启后，等价于在设置页中打开「启用 Claude CLI 意图路由」

---

## 供应商描述（用于意图识别）

跨供应商意图路由时，CC Switch 会把 **每个已启用 Claude 供应商** 的描述发给“路由模型”，由它来选择最合适的那个。

### 配置入口

1. 在主界面进入「Claude」应用
2. 打开「供应商」列表
3. 点击某个供应商的「编辑」
4. 在弹出的编辑面板中填写：
   - **名称**：用于区分不同供应商，例如 `Zhipu-GLM`、`Univibe-Claude`
   - **描述（notes）**：通用说明
   - **意图路由描述（Intent Description）**：专门用来告诉路由模型“这个供应商适合什么任务”

> 实现上，路由时会优先使用「意图路由描述」，如果为空则回退到「描述（notes）」。

### 描述编写建议

意图描述应该 **简短、具体、可区分**，例如：

- `适合复杂数学推理和公式推导`
- `适合大规模代码库的重构和跨文件分析`
- `超快响应的日常对话和小片段代码解释`
- `适合长上下文技术文档翻译和润色`

不要写：
- 只写供应商名字，例如：`Univibe`（信息不足）
- 同时写很多重叠能力，让多个供应商都变成“全能型”，会降低路由效果

---

## 会话级绑定：只在第一次提问路由

为了避免“同一个任务中途换供应商”，意图路由采用 **会话级绑定策略**：

1. **首次提问**（新会话首轮）：
   - 当 Claude CLI 请求的 `messages` 中：
     - 只有一条 `role: "user"` 消息
     - 还没有任何 `role: "assistant"` 消息
   - 认为是“新会话的第一次提问”
   - 此时会执行 **跨供应商意图路由**，在所有已配置供应商中选择一个
2. **后续轮次**（同一会话）：
   - 只要 `messages` 里出现过 assistant 回复，或 user/assistant 已有多轮对话
   - 就视为“已有会话”
   - 此时 **不再做跨供应商意图路由**，继续使用第一次选中的供应商

这样，同一个对话在中途不会从 A 供应商跳到 B 供应商，只会：
- 在会话开始时选一次供应商
- 在该供应商内部做模型级选择（例如选择不同大小的模型）

> 如果你修改了某个供应商的意图描述，希望新配置生效，请从 Claude CLI 开启一个新对话（只包含一条首轮 user 消息），让新会话跑一遍意图路由。

---

## 路由决策是如何做的？

### 1. 收集候选供应商

当你启用 Claude 接管并打开意图路由时，CC Switch 会：

- 从数据库中读取所有 Claude 供应商（每个供应商通常对应一个 API Key）
- 对每个供应商：
  - 找出它的「主模型」：从 env 中优先读取 `ANTHROPIC_MODEL`，否则回退到各类默认 Claude 模型变量
  - 提取「意图路由描述」或 `notes`

得到候选列表：

```text
1. Univibe-Claude: 适合复杂数学推理和公式推导 (model: xxx)
2. Zhipu-GLM: 适合通用对话和代码解释 (model: yyy)
3. 其他供应商...
```

### 2. 选择“路由模型”

- 如果在设置里指定了「路由专用供应商」，优先使用该供应商的主模型作为“路由模型”
- 否则使用当前 Claude 供应商的主模型

### 3. 构造路由提示词

路由提示词包含：

- 估算出来的请求大致长度（短 / 中 / 长）
- 所有候选供应商 + 模型 + 描述
- 最近一条 user 消息的摘要（最多 2000 字符）
- 要求路由模型 **只返回 1~N 的一个整数索引**

### 4. 路由结果与回退

- 如果路由模型返回了合法索引：
  - 使用对应供应商的主模型作为本次调用的目标模型
  - 该供应商在故障转移链中排在第一位
- 如果路由调用失败（比如返回 400 或解析出错）：
  - 打印一条警告日志
  - 回退到简单的“长度启发式”内部路由：
    - 短请求偏向小模型
    - 中/长请求偏向更强模型

---

## 使用示例

### 场景一：数学计算走 Univibe-Claude

1. 配置两个 Claude 供应商：
   - `Zhipu-GLM`：意图描述写「适合通用对话和代码解释」
   - `Univibe-Claude`：意图描述写「当数学计算、公式推导、复杂推理时使用该模型」
2. 启用代理、Claude 接管，并开启「启用 Claude CLI 意图路由」
3. 在 Claude CLI 输入：

```text
请详细证明：如果 a,b>0 且 a+b=1，证明 a^2 + b^2 ≥ 1/2，并给出等号成立条件。
```

路由模型会偏向选择描述中提到“数学计算”的 `Univibe-Claude`，整个会话后续问题（继续追问证明细节等）都会保持在同一供应商上。

### 场景二：长代码分析走某个专用供应商

1. 为某个供应商填写意图描述：
   - `擅长大型代码库分析、跨文件调用链跟踪和重构建议`
2. 当首轮请求内容是“贴了一大段代码并让模型找 bug / 重构”时，路由模型更可能选择这个供应商。

---

## 常见问题

### Q: 为什么中途感觉模型风格发生了变化？

A: 会话级绑定已经避免了“中途换供应商”。如果你感觉风格变化，更可能是：
- 同一供应商内部不同模型被选中；或
- 上游模型本身更新（供应商侧变化）。

你可以在 CC Switch 日志中查看每次请求实际调用的 `provider` 和 `model`。

### Q: 修改意图描述后，旧会话会受影响吗？

A: 不会。  
旧会话已经在第一次请求时绑定了供应商，后续不会再次跑跨供应商路由。  
新描述只会影响 **新的会话**。

### Q: 我只想用一个供应商，但希望它内部按任务自动选不同模型？

A: 可以：
- 只配置一个 Claude 供应商（或只启用一个）
- 继续开启「启用 Claude CLI 意图路由」
- 这样就只会在该供应商内部做模型级路由，不会跨供应商切换。

